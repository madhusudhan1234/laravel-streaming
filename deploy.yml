import:
  - recipe/laravel.php

config:
  repository: 'https://github.com/madhusudhan1234/laravel-streaming.git'
  shared_files: ['.env']
  shared_dirs:
    - storage
  writable_dirs:
    - storage
    - bootstrap/cache
  keep_releases: 2

hosts:
  production:
    hostname: 'audio.lifeandmessage.com'
    remote_user: deployer
    deploy_path: '/var/www/audio.lifeandmessage.com'
    port: 22
    ssh_options:
      UserKnownHostsFile: /dev/null
      StrictHostKeyChecking: no
      PasswordAuthentication: no
      IdentitiesOnly: yes
      LogLevel: ERROR
    forward_agent: true

tasks:
  init:
    - run: 'mkdir -p {{deploy_path}}/.dep'
  build:
    - run: uptime
  deploy:assets:
    - run: 'cd {{release_path}} && npm ci'
    - run: 'cd {{release_path}} && npm run build'  
  
  deploy:
    - deploy:prepare
    - deploy:vendors
    - artisan:storage:link
    - artisan:config:cache
    - artisan:route:cache
    - artisan:view:cache
    - artisan:migrate
    - deploy:assets
    - deploy:symlink
    - deploy:unlock
    - deploy:cleanup

after:
  deploy:failed: deploy:unlock
